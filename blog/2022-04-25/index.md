---
slug: 阅读日记2 tcp协议是如何工作的
title: 阅读日记2 tcp协议是如何工作的
authors:
  name: Nikki
  title: a coder
#   url: https://github.com/wgao19
  image_url: https://avatars.githubusercontent.com/u/59378631?s=400&u=5c50f7a8cf81217122611fb72484a0288d90a739&v=4
tags: [tcp]
---

衡量web页面性能的重要指标：**FP**（First Paint），指从页面加载到首次开始绘制的时长；

影响FP的重要因素：**网络加载速度**

在网络中，不管是使用HTTP还是WebSocket，他们都是基于**TCP/IP**

#### Web世界中的TCP/IP是如何工作的？

如何保证页面文件能被完整地送达浏览器？

数据包的旅程：数据包----->主机----->应用

**1.IP：把数据包送达目的主机**

数据包要在互联网上进行传输，就要符合网际协议（**IP**）标准。

计算机的地址就称为**IP地址**，访问任何网站实际上只是你的计算机向另外一台计算机 请求信息。

每个IP数据包都有IP头，包括IP版本，源IP地址，目标IP地址，生存时间等信息

![img](https://static001.geekbang.org/resource/image/00/4d/00d9bcad0bda1fdb43ead428e89ae74d.png)

**2.UDP：把数据包送达应用程序**

IP只负责把数据包传送到对方主机，但主机并不知道要把数据包交给哪个程序，因此，这时就需要基于IP之上开发能和应用打交道的协议，最常见的是”用户数据包协议“，简称**UDP**

UDP中最重要的信息是**端口号**，每个需要访问网络的应用程序需要绑定不同的端口号，所以通过端口号UDP就能把数据包发给指定的应用程序；

总结就是：

**IP通过IP地址把数据包发送给指定的电脑，而UDP通过端口号把数据包分发给正确的程序**

![img](https://static001.geekbang.org/resource/image/3e/ea/3edb673a43f23d84253c52124ce447ea.png)

UDP的传输速度很快，一般应用于在线视频，互动游戏等领域，但是，udp不能保证数据的可靠传输，对于错误的数据包，不会提供重传机制，而是选择直接丢弃，也没有确认机制。

为了解决这个问题，我们引入了TCP

**3.TCP：把数据完整地送达应用程序**

TCP协议是一种面向连接地，可靠的，基于字节流地传输层通信协议，提供超时重传和确认机制，还提供了数据包排序机制

TCP头包含了目标端口，本机端口，用于排序地序列号，便于接收端通过序号来重排数据包

![img](https://static001.geekbang.org/resource/image/94/32/943ac29f7d5b45a8861b0cde5da99032.png)

**一个完整地TCP连接过程**：

![img](https://static001.geekbang.org/resource/image/44/44/440ee50de56edc27c6b3c992b3a25844.png)

三次握手建立连接

传输数据

四次挥手断开连接



一些疑问：

1. 浏览器可以同时打开多个页签，他们端口一样吗？如果一样，数据怎么知道去哪个页签？

​	 端口一样的，网络进程知道每个tcp链接所对应的标签是那个，所以接收到数据后，会把数据分发给对应的渲染进程

2. TCP传送数据时 浏览器端就做渲染处理了么？如果前面数据包丢了 后面数据包先来是要等么？类似的那种实时渲染怎么处理？针对数据包的顺序性？   

   接收到http响应头中的content-type类型时就开始准备渲染进程了，响应体数据一旦接受到便开始做DOM解析了！基于http不用担心数据包丢失的问题，因为丢包和重传都是在tcp层解决的。http能保证数据按照顺序接收的（也就是说，从tcp到http的数据就已经是完整的了，即便是实时渲染，如果发生丢包也得在重传后才能开始渲染） 

3. http 和 websocket都是属于应用层的协议吗？ 

   都是应用层协议，而且websocket名字取的比较有迷惑性，其实和socket完全不一样，可以把websocket看出是http的改造版本，增加了服务器向客户端主动发送消息的能力。 

4. 关于 "数据在传输的过程中有可能会丢失或者出错"，丢失的数据包去哪里了？凭空消失了吗？出错的数据包又变成啥了？ 为什么会出错？ 

   比如网络波动，物理线路故障，设备故障，恶意程序拦截，网络阻塞等等