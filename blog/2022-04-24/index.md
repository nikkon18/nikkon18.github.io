---
slug: 阅读日记1 chrome浏览器发展过程
title: 阅读日记1 chrome浏览器发展过程
authors:
  name: Nikki
  title: a coder
  # url: https://github.com/wgao19
  image_url: https://avatars.githubusercontent.com/u/59378631?s=400&u=5c50f7a8cf81217122611fb72484a0288d90a739&v=4
tags: [浏览器]
---
观察一个现象：

打开一个页面后，再打开chrome的任务管理器，发现启动了多个进程

![img](https://static001.geekbang.org/resource/image/ce/9e/ce7f8cfe212bec0f53360422e3b03a9e.png)

**单线程**执行任务是分步按顺序执行任务的；

**多线程**可以同时处理多个任务，并行处理让性能大大提升

那么

线程和进程分别是什么？

- 线程：不能单独存在，由进程来启动和管理
- 进程：一个进程就是一个程序的运行实例（在启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码，运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫进程）

关系：线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率

- 进程中的任意线程执行出错，都会导致整个进程的崩溃
- 线程之间共享进程中的数据
- 当一个进程关闭之后，操作系统会回收进程所占用的内存
- 进程之间的内容相互隔离

从前：**单进程浏览器时代**

指的是浏览器的所有功能模块都是运行在同一个进程里

![img](https://static001.geekbang.org/resource/image/6d/ca/6ddad2419b049b0eb2a8036f3dfff1ca.png)

单进程浏览器会导致浏览器不稳定（一个插件的崩溃会导致进程崩溃），不流畅（一个时刻只能有一个模块可以执行，假如运行的是无限循环脚本，将独占线程持续卡顿），不安全（恶意插件带来安全性问题）

现在：**多进程浏览器时代**

![img](https://static001.geekbang.org/resource/image/cd/60/cdc9215e6c6377fc965b7fac8c3ec960.png)

chrome的页面是运行在单独的渲染进程中的，同时页面里的插件也是运行在单独的插件进程之中，而进程之间是通过IPC机制进行通信

- 解决了不稳定的问题：进程相互隔离，一个页面或插件崩溃只会影响到当前的页面进程或插件进程
- 解决了不流畅的问题：js运行在渲染进程中，即使js阻塞了渲染进程，影响到的也仅仅是当前的渲染页面，其他页面的脚本是运行在自己的渲染进程中的
- 解决了安全问题：使用安全沙箱，相当于操作系统给进程上了一把锁，沙箱里的程序可以运行，但不能在硬盘上写入和读取任何数据。chrome把插件进程和渲染进程都锁在了沙箱里面

**最新的浏览器架构**

![img](https://static001.geekbang.org/resource/image/b6/fc/b61cab529fa31301bde290813b4587fc.png)

- 浏览器进程：负责界面显示，用户交互，子进程管理，同时提供存储等功能
- 渲染进程：核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下
- GPU进程：最初是为了实现3D css效果，后来chrome的ui界面都选择采用GPU绘制
- 网络进程：负责页面的网络资源加载
- 插件进程：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

再回顾一下开始的现象，打开一个页面，却有4个进程。这是因为打开 1 个页面至少需要 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，共 4 个；如果打开的页面有运行插件的话，还需要再加上 1 个插件进程。

多进程浏览器缺点：

- 更高的资源占用
- 更复杂的体系架构

正在探索的未来浏览器：**面向服务的架构**（SOA）

原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统，更好实现 Chrome 简单、稳定、高速、安全的目标。

![img](https://static001.geekbang.org/resource/image/32/2a/329658fe821252db47b0964037a1de2a.png)

一些小疑问：

即使是如今的多进程架构，偶尔还是会碰到一些由于单个页面卡死最终崩溃导致所有页面崩溃的情况，这是什么原因呢？

chrome的默认策略是每个标签对应一个渲染进程，但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程

同一站点：根域名，协议相同，端口不同或者相同的网站

为什么要让他们跑在一个进程里面呢？

因为在一个渲染进程里面，他们就会共享JS的执行环境，也就是说A页面可以直接在B页面中执行脚本。(A,B站点进行通信传输数据)因为是同一家的站点，所以是有这个需求的

A页面可以直接在B页面中执行脚本是什么意思？

例如在本页面(简称B)左上角有一个“立即订阅”按钮，点开可以跳转到新页面(简称A)，在新页面A打开控制台，可以使用window.opener拿到B页面的window数据，同样使用window.opener.location.href或者其他API控制B页面跳转或操作其它window上的东西 这种跳转有点不安全，如果是a标签，可以通过

```html
<a href='/index' rel=noopener>链接<a/>
```

来实现跳转，新页面就拿不到window.opener了